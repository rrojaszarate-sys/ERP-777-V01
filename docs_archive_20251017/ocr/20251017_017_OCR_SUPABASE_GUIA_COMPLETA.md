# üöÄ OCR con SUPABASE - Gu√≠a Completa

## ‚ú® Nueva Arquitectura

**TODO centralizado en Supabase:**
- ‚úÖ Edge Functions para OCR
- ‚úÖ Storage con versionado autom√°tico
- ‚úÖ Base de datos con historial
- ‚úÖ RLS (Row Level Security)
- ‚úÖ Sin servidor Node.js separado

---

## üèóÔ∏è Arquitectura

```
Frontend (React)
      ‚Üì
Supabase Edge Function (Deno)
      ‚Üì
Google Vision API
      ‚Üì
   Resultados
      ‚Üì
‚îú‚îÄ Storage Bucket (versionado)
‚îî‚îÄ Base de Datos (historial)
```

### Estructura del Bucket
```
event-docs/
‚îî‚îÄ‚îÄ {eventoId}/
    ‚îî‚îÄ‚îÄ gastos/
        ‚îú‚îÄ‚îÄ 1234567890-v1-ticket_oxxo.jpg
        ‚îú‚îÄ‚îÄ 1234567890-v2-ticket_oxxo.jpg  ‚Üê Versi√≥n actualizada
        ‚îî‚îÄ‚îÄ 1234567891-v1-factura_pemex.jpg
```

### Tabla de Base de Datos
```sql
evt_documentos_ocr
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ evento_id
‚îú‚îÄ‚îÄ archivo_path          ‚Üê Path con versi√≥n
‚îú‚îÄ‚îÄ version               ‚Üê N√∫mero de versi√≥n
‚îú‚îÄ‚îÄ texto_completo
‚îú‚îÄ‚îÄ confianza_general
‚îú‚îÄ‚îÄ datos_extraidos       ‚Üê JSON con todos los datos
‚îú‚îÄ‚îÄ gasto_id              ‚Üê Vinculado con gasto
‚îî‚îÄ‚îÄ timestamps & auditor√≠a
```

---

## üì¶ INSTALACI√ìN

### 1. Ejecutar Migraci√≥n

```bash
cd /home/rodrichrz/proyectos/V20---\ recuperacion/project2

# Aplicar migraci√≥n
npx supabase db push
```

O manualmente en Supabase Dashboard ‚Üí SQL Editor:
```sql
-- Copiar contenido de:
supabase/migrations/20251011_ocr_documents_versioning.sql
```

### 2. Configurar Bucket

**En Supabase Dashboard:**

1. Ir a Storage ‚Üí Buckets
2. Verificar que existe `event-docs`
3. Configurar permisos:
   - **Public**: NO (privado)
   - **RLS**: Habilitado

**Pol√≠ticas de Storage:**
```sql
-- Usuarios pueden subir a sus eventos
CREATE POLICY "Users can upload to their events"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'event-docs');

-- Usuarios pueden leer documentos de sus eventos
CREATE POLICY "Users can read event documents"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'event-docs');
```

### 3. Configurar Google Vision Credentials

**En Supabase Dashboard:**

1. Ir a **Settings ‚Üí API**
2. En **Secrets** (Variables de entorno), agregar:

```
GOOGLE_VISION_CREDENTIALS
```

Valor (JSON completo de credentials):
```json
{"type":"service_account","project_id":"tu-proyecto","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n","client_email":"...@tu-proyecto.iam.gserviceaccount.com"}
```

### 4. Deploy Edge Function

```bash
# Iniciar sesi√≥n en Supabase
npx supabase login

# Deploy funci√≥n
npx supabase functions deploy ocr-process

# Verificar deployment
npx supabase functions list
```

---

## üéØ USO

### En el Formulario de Gastos

```typescript
import { useOCRSupabase } from '@/modules/ocr/hooks/useOCR.supabase';

function ExpenseForm({ eventId }: Props) {
  const { processExpenseFile, isProcessing, result } = useOCRSupabase(eventId);

  const handleOCRFile = async (file: File) => {
    try {
      const resultado = await processExpenseFile(file);

      // resultado.expense contiene todos los campos prellenados
      // resultado.ocr_result.archivo tiene la info del archivo guardado
      // resultado.calidad indica qu√© tan buenos son los datos

      setFormData(prev => ({
        ...prev,
        ...resultado.expense,
        // El archivo YA est√° guardado en bucket
        archivo_adjunto: resultado.ocr_result.archivo.url
      }));

      alert(`‚úÖ OCR completado!
üìä Calidad: ${resultado.calidad}
üíæ Archivo: ${resultado.ocr_result.archivo.path}
üî¢ Versi√≥n: ${resultado.ocr_result.archivo.version}`);

    } catch (error) {
      console.error('Error OCR:', error);
    }
  };

  return (
    <button onClick={() => fileInput.click()} disabled={isProcessing}>
      {isProcessing ? 'Procesando...' : 'Extraer con OCR'}
    </button>
  );
}
```

### Obtener Historial de Versiones

```typescript
const { getDocumentVersions } = useOCRSupabase(eventId);

// Obtener todas las versiones de un archivo
const versiones = await getDocumentVersions('ticket_oxxo.jpg');

versiones.forEach(v => {
  console.log(`Versi√≥n ${v.version}: ${v.archivo_path}`);
  console.log(`Confianza: ${v.confianza_general}%`);
  console.log(`Total: $${v.datos_extraidos.total}`);
});
```

### Ver Documentos del Evento

```typescript
import { useOCRDocuments } from '@/modules/ocr/hooks/useOCR.supabase';

function DocumentosOCR({ eventId }: Props) {
  const { documents, isLoading, loadDocuments } = useOCRDocuments(eventId);

  useEffect(() => {
    loadDocuments();
  }, [eventId]);

  return (
    <div>
      <h3>Documentos Procesados: {documents.length}</h3>
      {documents.map(doc => (
        <div key={doc.id}>
          <p>{doc.nombre_archivo} - v{doc.version}</p>
          <p>Confianza: {doc.confianza_general}%</p>
          <p>Total: ${doc.datos_extraidos.total}</p>
        </div>
      ))}
    </div>
  );
}
```

---

## üîÑ Sistema de Versionado

### C√≥mo Funciona

1. **Primera subida**:
   ```
   ticket_oxxo.jpg ‚Üí event-docs/evento-123/gastos/1234567890-v1-ticket_oxxo.jpg
   ```

2. **Segunda subida del mismo archivo**:
   ```
   ticket_oxxo.jpg ‚Üí event-docs/evento-123/gastos/1234567891-v2-ticket_oxxo.jpg
   ```

3. **Tercera subida**:
   ```
   ticket_oxxo.jpg ‚Üí event-docs/evento-123/gastos/1234567892-v3-ticket_oxxo.jpg
   ```

### Ventajas

- ‚úÖ **Nunca se pierde informaci√≥n**: Todas las versiones se guardan
- ‚úÖ **Historial completo**: Puedes ver c√≥mo cambi√≥ la extracci√≥n
- ‚úÖ **Auditor√≠a**: Sabes cu√°ndo y qui√©n subi√≥ cada versi√≥n
- ‚úÖ **Comparaci√≥n**: Puedes comparar resultados de diferentes versiones

### Ejemplo Real

```typescript
// Obtener versiones de un ticket
const versiones = await getDocumentVersions('ticket_oxxo.jpg');

// v1: Foto borrosa ‚Üí Confianza 45%, Total no detectado
// v2: Foto mejor ‚Üí Confianza 75%, Total $117.00 (incorrecto)
// v3: Foto perfecta ‚Üí Confianza 92%, Total $117.50 (correcto!)

// Puedes usar la v3 que tiene mejor calidad
const mejorVersion = versiones.find(v => v.confianza_general === 92);
```

---

## üìä Consultas √ötiles

### Obtener Documentos Pendientes de Vincular

```sql
SELECT *
FROM evt_documentos_ocr
WHERE evento_id = 'tu-evento-id'
  AND gasto_id IS NULL
  AND estado_procesamiento = 'completed'
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

### Estad√≠sticas de Calidad

```sql
SELECT
  AVG(confianza_general) as confianza_promedio,
  COUNT(*) as total_documentos,
  COUNT(CASE WHEN confianza_general >= 85 THEN 1 END) as excelentes,
  COUNT(CASE WHEN confianza_general >= 70 AND confianza_general < 85 THEN 1 END) as buenos,
  COUNT(CASE WHEN confianza_general < 70 THEN 1 END) as regulares
FROM evt_documentos_ocr
WHERE evento_id = 'tu-evento-id'
  AND deleted_at IS NULL;
```

### Ver Historial de Versiones

```sql
SELECT
  nombre_archivo,
  version,
  confianza_general,
  datos_extraidos->'total' as total,
  created_at
FROM evt_documentos_ocr
WHERE evento_id = 'tu-evento-id'
  AND nombre_archivo LIKE '%ticket_oxxo%'
  AND deleted_at IS NULL
ORDER BY version DESC;
```

---

## üîí Seguridad

### Row Level Security (RLS)

Autom√°ticamente aplicado:

```sql
-- Los usuarios solo ven documentos de sus eventos
CREATE POLICY "Users can view OCR documents of their events"
ON evt_documentos_ocr FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM eventos
    WHERE eventos.id = evt_documentos_ocr.evento_id
  )
);
```

### Storage Security

```sql
-- Solo pueden subir a carpetas de sus eventos
CREATE POLICY "Users can upload to their events"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'event-docs' AND
  (storage.foldername(name))[1] IN (
    SELECT id::text FROM eventos
    WHERE created_by = auth.uid()
  )
);
```

---

## üöÄ Deployment a Producci√≥n

### 1. Configurar Secrets en Supabase

```bash
# Listar secrets actuales
npx supabase secrets list --project-ref tu-proyecto-ref

# Agregar Google Vision credentials
npx supabase secrets set GOOGLE_VISION_CREDENTIALS='{"type":"service_account",...}'
```

### 2. Deploy Edge Function

```bash
# Deploy a producci√≥n
npx supabase functions deploy ocr-process --project-ref tu-proyecto-ref

# Verificar logs
npx supabase functions logs ocr-process --project-ref tu-proyecto-ref
```

### 3. Verificar URL

La URL ser√°:
```
https://tu-proyecto-ref.supabase.co/functions/v1/ocr-process
```

### 4. Actualizar Frontend

En `.env.production`:
```bash
VITE_SUPABASE_URL=https://tu-proyecto-ref.supabase.co
VITE_SUPABASE_ANON_KEY=tu-anon-key
```

---

## üí∞ Costos

### Supabase
- **Edge Functions**: Gratis hasta 500,000 invocaciones/mes
- **Storage**: Gratis hasta 1GB
- **Base de datos**: Gratis hasta 500MB

### Google Vision API
- **Tier gratuito**: 1,000 im√°genes/mes
- **Despu√©s**: $1.50 USD por 1,000 im√°genes

### Ejemplo
- 100 tickets/d√≠a = 3,000/mes
- **Supabase**: $0 (dentro del tier gratuito)
- **Google Vision**: $3 USD/mes

---

## üêõ Troubleshooting

### Edge Function no responde

```bash
# Ver logs
npx supabase functions logs ocr-process

# Verificar deployment
npx supabase functions list
```

### Error de credenciales

Verificar que `GOOGLE_VISION_CREDENTIALS` est√© configurado:
```bash
npx supabase secrets list
```

### Archivo no se guarda en bucket

Verificar pol√≠ticas de storage:
```sql
SELECT * FROM storage.policies
WHERE bucket_id = 'event-docs';
```

### RLS bloquea acceso

Verificar pol√≠ticas de tabla:
```sql
SELECT * FROM pg_policies
WHERE tablename = 'evt_documentos_ocr';
```

---

## üìà Monitoreo

### Ver Estad√≠sticas

```typescript
const { getEventStats } = useOCRSupabase(eventId);

const stats = await getEventStats();

console.log(stats);
// {
//   total: 45,
//   completados: 42,
//   fallidos: 3,
//   confianzaPromedio: 87,
//   porProcesador: {
//     google_vision: 45,
//     tesseract: 0
//   }
// }
```

### Dashboard SQL

```sql
-- Dashboard de OCR por evento
SELECT
  e.nombre as evento,
  COUNT(d.*) as total_documentos,
  AVG(d.confianza_general)::int as confianza_promedio,
  SUM((d.datos_extraidos->>'total')::numeric) as total_gastos_detectados
FROM evt_documentos_ocr d
JOIN eventos e ON e.id = d.evento_id
WHERE d.deleted_at IS NULL
  AND d.estado_procesamiento = 'completed'
GROUP BY e.id, e.nombre
ORDER BY total_documentos DESC;
```

---

## ‚úÖ Checklist de Verificaci√≥n

- [ ] Migraci√≥n aplicada (`evt_documentos_ocr` existe)
- [ ] Bucket `event-docs` configurado
- [ ] RLS habilitado en tabla y bucket
- [ ] Google Vision credentials configuradas
- [ ] Edge Function deployada
- [ ] Frontend actualizado para usar Supabase
- [ ] Probado con 1 ticket
- [ ] Versionado funcionando (subir mismo archivo 2 veces)
- [ ] Historial visible en tabla

---

## üéâ Ventajas vs Versi√≥n Anterior

| Aspecto | Antes (Node.js) | Ahora (Supabase) |
|---------|-----------------|------------------|
| **Backend** | Servidor separado | Edge Functions |
| **Deployment** | Manual | `npx supabase functions deploy` |
| **Escalabilidad** | Manual | Autom√°tica |
| **Costo servidor** | $5-20/mes | $0 (tier gratuito) |
| **Versionado** | Manual | Autom√°tico |
| **Historial** | No | S√≠ (en BD) |
| **Auditor√≠a** | B√°sica | Completa |
| **RLS** | No | S√≠ |
| **Mantenimiento** | Alto | Bajo |

---

## üìö Recursos

- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [Supabase Storage](https://supabase.com/docs/guides/storage)
- [Google Vision API](https://cloud.google.com/vision/docs)
- [RLS en Supabase](https://supabase.com/docs/guides/auth/row-level-security)

---

**Versi√≥n**: 3.0.0 (Supabase)
**Fecha**: Octubre 2025
**Estado**: ‚úÖ PRODUCCI√ìN READY

üöÄ **¬°Todo centralizado en Supabase con versionado autom√°tico!**
